id: "docdd_v4"
name: "DocDD (Document Driven Development)"
version: 4

definition:
  summary: >
    戦略マスタードキュメントと運用ノートの二層をテンプレート化し、
    Botとワークフローで強制力を持たせることで、意思決定と変更管理を同一線上で運用するフレーム。
  details: |
    v4では「テンプレート」「Botガードレール」「例外ハンドリング」を標準装備として再構成する。
    - マスター: 目的・用語・境界条件・リスク承認・責任者・有効期限・例外条件を含む固定セクション。
    - 運用ノート: チケット/PR/リリースに自動リンクされる差分ログ、レビュー観点、証跡スナップショットを保持。
    - Bot: マスター↔運用ノートの整合チェック、例外宣言/復帰期限の追跡、CI停止、Slack/メール通知を担う。
    さらに、観測データ（可用性・セキュリティイベント）を運用ノートに引用し、意思決定理由と紐づけることで
    「何をもとに判断したか」が常に可視化される状態を作る。

usage_context:
  description: >
    認可/監査要件が高く、分散チームや委託先が多いプロダクトで、迅速リリースと証跡整合を両立したい場合。
    データ所在や規制が国・業界ごとに変わる環境、災害対策/セキュリティ変更を頻繁に行う環境で特に効果的。
  examples:
    - "金融・医療SaaSで、国別法規ごとに前提と制約をマスターに保持し、運用ノートで差分を記録するケース"
    - "複数ベンダーが関与する自治体システム刷新で、CABと開発PRをDocDD Botが橋渡しするケース"
    - "障害復旧やZero-day対応で例外運用を発動し、復帰期限と是正策を追跡するケース"

decision_axes:
  - name: "テンプレート遵守度"
    description: "マスター/運用ノート双方で必須セクションが埋まり、更新時に差分説明が残っているか"
  - name: "Botガードレールの有効度"
    description: "未整合検知・CI停止・通知が機能し、手動バイパスは例外宣言としてログ化されるか"
  - name: "例外運用の宣言と復帰管理"
    description: "PoC/Hotfix等の例外開始・期限・復帰条件が記録され、期限内に通常運用へ戻れているか"
  - name: "意思決定の観測データ連携"
    description: "可用性・品質・セキュリティ指標など判断材料がドキュメントに引用されているか"
  - name: "ステークホルダー連携"
    description: "事業・技術・SRE/セキュリティ・コンプラがDocDDイベントに定常参加し、責任境界が明確か"

primary_roles:
  - "program_manager"
  - "product_owner"
  - "system_architect"
  - "qa_lead"
  - "sre_manager"
  - "security_engineer"
  - "compliance_officer"

anti_patterns:
  - name: "テンプレート未充填の承認"
    description: "必須セクションが空のまま承認し、後で理由や前提が追跡できない"
  - name: "Botバイパス常態化"
    description: "例外宣言をせずにCIを手動解除し、証跡に残さない"
  - name: "観測データ非連携"
    description: "インシデントやSLO変化をドキュメントに反映せず、判断根拠が属人的になる"
  - name: "責任境界の漂流"
    description: "更新・承認・例外管理の責任者が決まらず、レビューが滞留する"
  - name: "リンク不整合放置"
    description: "チケット/PR/リリースノートとドキュメントが切断され、監査で辿れない"

practices:
  templates:
    master_sections:
      - "目的・スコープ"
      - "用語・境界条件"
      - "リスク/例外の承認状況"
      - "責任者・意思決定フロー"
      - "有効期限と見直しサイクル"
    operation_note_sections:
      - "差分概要と関連チケット/PR"
      - "テスト/検証結果リンク"
      - "影響範囲とロール別の確認状況"
      - "観測データの引用(エラー率/SLO/セキュリティイベント等)"
      - "例外運用の開始・終了ログ"
  automation:
    - "DocDD BotがPR/MRでマスターと運用ノートの整合性チェックを実行し、欠落時はCIをFailにする"
    - "例外宣言フォームから期限・責任者を登録し、期限超過でアラートする"
    - "リリースノート生成時にDocDDリンクを必須フィールドとし、欠落時は公開をブロックする"
    - "可観測性プラットフォームからSLO/SI指標を自動引用し、意思決定セクションに貼り付ける"
  governance:
    - "月次 DocDD 健全性レビューを開催し、メトリクスと例外ログを確認"
    - "四半期ごとにテンプレートを更新し、組織変更や規制変更を反映"
    - "ステークホルダー間でオンコール/承認権限の委譲ルールを明文化"

warning_signals:
  - "Bot阻止件数が減少し、未整合リリースが増え始めている"
  - "例外運用の復帰期限超過が連続し、通常DocDDに戻らない"
  - "観測データ引用が無く、判断理由が会話ログにしか残らない"
  - "マスター更新が3スプリント以上停止し、運用ノートとの乖離が拡大"

evaluation:
  qualitative:
    guidelines: |
      - テンプレート必須セクションが埋まり、レビュー時に差分説明と観測データが提示されているか
      - 例外運用の開始/復帰ログが残り、ステークホルダーが合意しているか
      - Botが未整合を検知しCI/Pipelineを止め、バイパス時は例外として記録されているか
      - 月次/四半期レビューでメトリクスの改善アクションが合意・実行されているか
  quantitative:
    metrics:
      - name: "DocDD同期遅延中央値"
        description: "実装変更とマスター更新の時間差中央値"
      - name: "例外復帰遵守率"
        description: "例外運用が期限内に通常DocDDへ戻った割合"
      - name: "Bot阻止件数"
        description: "DocDD Botが未整合リリースを阻止した件数"
      - name: "観測データ引用率"
        description: "意思決定ログにSLO/インシデント/リスク指標などの引用が含まれる割合"
      - name: "テンプレート充填率"
        description: "必須セクションが欠落なく埋まったDocDD文書の割合"
      - name: "リンクトレーサビリティ網羅率"
        description: "ドキュメント→チケット→PR→リリースノートのチェーンが揃っている割合"

examples:
  success_cases:
    - description: >
        金融SaaSでv4テンプレートとBotを導入し、観測データ引用率が90%に向上。
        監査準備時間が半減し、未整合リリースは四半期ゼロを維持した。
  failure_cases:
    - description: >
        緊急対応が続く中で例外宣言を省略し、CIを手動解除し続けた結果、
        復帰条件を見失い重大インシデント後の原因分析に時間を要した。

relations:
  synergies:
    - "tdd"
    - "ddd"
    - "rfc_driven_development"
    - "compliance_driven_dev"
    - "observability_driven_ops"
  conflicts:
    - "prototype_only_style"
    - "verbal_alignment_culture"
    - "cowboy_deploy"
  notes: >
    Botや可観測性との統合を前提としたDocDDのため、プロトタイピングでは運用ノートのみの軽量版を使用し、
    Go判定でマスター層に昇格させる。委託先・マルチベンダー環境では権限委譲とレビュー頻度を明記し、
    例外運用も契約上合意したうえで実施する。
